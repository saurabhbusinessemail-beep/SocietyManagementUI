<!-- user-management.component.html -->
<app-layout>
    <div class="user-management">
        <!-- Header -->
        <div class="user-header">
            <ui-button label="Add User" (clicked)="openAddModal()"></ui-button>
        </div>

        <!-- Search and Filters -->
        <div class="filters-section">
            <div class="search-box">
                <input type="text" placeholder="Search by name, email or phone..." (input)="onSearch($event)"
                    class="search-input">
            </div>

            <div class="filter-group">
                <select class="filter-select" (change)="onStatusFilterChange($any($event.target).value)">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="pending">Pending</option>
                    <option value="blocked">Blocked</option>
                </select>

                <select class="filter-select" (change)="onRoleFilterChange($any($event.target).value)">
                    <option value="all">All Roles</option>
                    <option value="admin">Admin</option>
                    <option value="user">User</option>
                </select>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading-state" *ngIf="isLoading">
            <div class="spinner"></div>
            <p>Loading users...</p>
        </div>

        <!-- Desktop Table View -->
        <div class="table-container desktop-view" *ngIf="!isLoading">
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let user of filteredUsers">
                        <td>{{ user.name || 'N/A' }}</td>
                        <td>{{ user.email || 'N/A' }}</td>
                        <td>{{ user.phoneNumber }}</td>
                        <td>
                            <span class="role-badge" [class.role-admin]="user.role === 'admin'">
                                {{ user.role }}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge" [ngClass]="getStatusClass(user.status)">
                                {{ user.status }}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="icon-btn view" (click)="openViewModal(user)">
                                üëÅÔ∏è
                            </button>
                            <button class="icon-btn edit" (click)="openEditModal(user)">
                                ‚úèÔ∏è
                            </button>
                            <button class="icon-btn status" (click)="updateUserNameOnly()">
                                üìù
                            </button>
                            <div class="status-dropdown">
                                <button class="icon-btn status">
                                    ‚ö°
                                </button>
                                <div class="dropdown-content">
                                    <a (click)="updateUserStatus(user, 'active')">Active</a>
                                    <a (click)="updateUserStatus(user, 'inactive')">Inactive</a>
                                    <a (click)="updateUserStatus(user, 'pending')">Pending</a>
                                    <a (click)="updateUserStatus(user, 'blocked')">Blocked</a>
                                </div>
                            </div>
                            <button class="icon-btn delete" (click)="openDeleteModal(user)">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                    <tr *ngIf="filteredUsers.length === 0">
                        <td colspan="6" class="no-data">No users found</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Mobile Card View -->
        <div class="mobile-view" *ngIf="!isLoading">
            <div class="user-cards">
                <div class="user-card" *ngFor="let user of filteredUsers">
                    <div class="card-header" (click)="toggleExpand(user._id)">
                        <div class="user-info">
                            <h3 class="user-name">{{ user.name || 'N/A' }}</h3>
                            <div class="user-contact">
                                <span class="contact-item">{{ user.email || 'N/A' }}</span>
                                <span class="contact-item">{{ user.phoneNumber }}</span>
                            </div>
                        </div>
                        <div class="badges">
                            <span class="role-badge" [class.role-admin]="user.role === 'admin'">
                                {{ user.role }}
                            </span>
                            <span class="status-badge" [ngClass]="getStatusClass(user.status)">
                                {{ user.status }}
                            </span>
                        </div>
                        <div class="expand-icon">
                            <span class="chevron" [class.rotated]="isExpanded(user._id)">‚ñº</span>
                        </div>
                    </div>

                    <!-- Collapsible Actions Section -->
                    <div class="card-actions" *ngIf="isExpanded(user._id)" [@slideToggle]>
                        <button class="action-btn view" (click)="openViewModal(user)">
                            <span class="btn-icon">üëÅÔ∏è</span>
                            <span class="btn-label">View</span>
                        </button>
                        <button class="action-btn edit" (click)="openEditModal(user)">
                            <span class="btn-icon">‚úèÔ∏è</span>
                            <span class="btn-label">Edit</span>
                        </button>
                        <button class="action-btn status" (click)="updateUserNameOnly()">
                            <span class="btn-icon">üìù</span>
                            <span class="btn-label">Name</span>
                        </button>
                        <div class="mobile-status-dropdown">
                            <button class="action-btn status">
                                <span class="btn-icon">‚ö°</span>
                                <span class="btn-label">Status</span>
                            </button>
                            <div class="dropdown-content">
                                <a (click)="updateUserStatus(user, 'active')">Active</a>
                                <a (click)="updateUserStatus(user, 'inactive')">Inactive</a>
                                <a (click)="updateUserStatus(user, 'pending')">Pending</a>
                                <a (click)="updateUserStatus(user, 'blocked')">Blocked</a>
                            </div>
                        </div>
                        <button class="action-btn delete" (click)="openDeleteModal(user)">
                            <span class="btn-icon">üóëÔ∏è</span>
                            <span class="btn-label">Delete</span>
                        </button>
                    </div>
                </div>

                <div class="no-data" *ngIf="filteredUsers.length === 0">
                    No users found
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination" *ngIf="totalUsers > pageSize">
            <button class="page-btn" [disabled]="currentPage === 1" (click)="onPageChange(currentPage - 1)">
                Previous
            </button>
            <span class="page-info">
                Page {{ currentPage }} of {{ getTotalPages() }}
            </span>
            <button class="page-btn" [disabled]="currentPage === getTotalPages()"
                (click)="onPageChange(currentPage + 1)">
                Next
            </button>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal" *ngIf="showUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New User</h2>
                <button class="close-btn" (click)="closeModals()">‚úï</button>
            </div>
            <div class="modal-body">
                <form [formGroup]="userForm" (ngSubmit)="createUser()">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" formControlName="name" placeholder="Enter name">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" formControlName="email" placeholder="Enter email">
                    </div>
                    <div class="form-group">
                        <label>Phone Number <span class="mandatory">*</span></label>
                        <input type="tel" formControlName="phoneNumber" placeholder="Enter phone number">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Role</label>
                            <select formControlName="role">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select formControlName="status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending</option>
                                <option value="blocked">Blocked</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" (click)="closeModals()">Cancel</button>
                <button class="btn-primary" (click)="createUser()" [disabled]="userForm.invalid || isSubmitting">
                    {{ isSubmitting ? 'Creating...' : 'Create User' }}
                </button>
            </div>
        </div>
    </div>

    <!-- View User Modal -->
    <div class="modal" *ngIf="showViewModal && selectedUser">
        <div class="modal-content">
            <div class="modal-header">
                <h2>User Details</h2>
                <button class="close-btn" (click)="closeModals()">‚úï</button>
            </div>
            <div class="modal-body view-details">
                <div class="detail-row">
                    <span class="label">Name:</span>
                    <span class="value">{{ selectedUser.name || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Email:</span>
                    <span class="value">{{ selectedUser.email || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Phone:</span>
                    <span class="value">{{ selectedUser.phoneNumber }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Role:</span>
                    <span class="value role-badge" [class.role-admin]="selectedUser.role === 'admin'">
                        {{ selectedUser.role }}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="label">Status:</span>
                    <span class="value status-badge" [ngClass]="getStatusClass(selectedUser.status)">
                        {{ selectedUser.status }}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="label">User ID:</span>
                    <span class="value">{{ selectedUser._id }}</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" (click)="closeModals()">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal" *ngIf="showEditModal && selectedUser">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit User</h2>
                <button class="close-btn" (click)="closeModals()">‚úï</button>
            </div>
            <div class="modal-body">
                <form [formGroup]="editForm" (ngSubmit)="updateUser()">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" formControlName="name" placeholder="Enter name">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" formControlName="email" placeholder="Enter email">
                    </div>
                    <div class="form-group">
                        <label>Phone Number <span class="mandatory">*</span></label>
                        <input type="tel" formControlName="phoneNumber" placeholder="Enter phone number">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Role</label>
                            <select formControlName="role">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select formControlName="status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending</option>
                                <option value="blocked">Blocked</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" (click)="closeModals()">Cancel</button>
                <button class="btn-primary" (click)="updateUser()" [disabled]="editForm.invalid || isSubmitting">
                    {{ isSubmitting ? 'Updating...' : 'Update User' }}
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" *ngIf="showDeleteModal && selectedUser">
        <div class="modal-content delete-modal">
            <div class="modal-header error">
                <h2>Delete User</h2>
                <button class="close-btn" (click)="closeModals()">‚úï</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete user <strong>{{ selectedUser.name || selectedUser.email ||
                        selectedUser.phoneNumber }}</strong>?</p>
                <p class="warning-text">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" (click)="closeModals()">Cancel</button>
                <button class="btn-delete" (click)="deleteUser()">Delete User</button>
            </div>
        </div>
    </div>
</app-layout>